# ローカルアバター機能要件定義書

## 1. 概要

Nag-Wonゲームにおいて、ユーザーがローカルに保存されたGLTFファイルをアバターとして使用できる機能を実装する。デフォルトのサーバーアバターはそのまま利用可能で、ローカルアバターはオプション機能として提供する。

## 2. 機能要件

### 2.1 基本機能

#### 2.1.1 ファイル選択機能
- **ファイル選択ダイアログ**: HTML5 File APIを使用したドラッグ&ドロップ対応のファイル選択
- **対応ファイル形式**: `.gltf`, `.glb`のみ受け付け
- **ファイルサイズ制限**: 最大50MBまで（3Dモデルファイルのサイズを考慮）
- **プレビュー機能**: 選択後に3Dプレビューを表示

#### 2.1.2 アニメーション検証機能
- **必須アニメーション確認**: 以下のアニメーションが含まれることを確認
  ```typescript
  const REQUIRED_ANIMATIONS = {
    'idle': ['Idle', 'idle', 'IDLE', 'idle_clip', 'idle01', 'Idle01'],
    'walking': ['Walk', 'walk', 'WALK', 'Walking', 'WalkForward', 'walk_clip'],
    'running': ['Run', 'run', 'RUN', 'Running', 'Sprint', 'sprint', 'run_clip'],
    'jumping': ['Jump', 'jump', 'JUMP', 'Jumping', 'jump_clip']
  };
  ```
- **アニメーション互換性チェック**: AnimationManagerのマッピングに対応しているか確認
- **エラーハンドリング**: 不適切なファイルの場合、詳細なエラーメッセージを表示

#### 2.1.3 データ永続化機能
- **LocalStorage保存**: 選択したファイルのObjectURLとメタデータを保存
- **セッション管理**: ページリロード後もローカルアバターを維持
- **フォールバック機能**: ファイルが削除/移動された場合、自動的にデフォルトアバターに切り替え

### 2.2 ユーザーインターフェース

#### 2.2.1 アバター選択画面
- **アバター選択モーダル**: ゲーム開始前またはゲーム中に選択可能
- **デフォルトアバター一覧**: 既存のサーバーアバターを表示
- **ローカルアバター追加ボタン**: 「カスタムアバターを追加」ボタン
- **切り替え機能**: デフォルトとローカルアバター間でのワンクリック切り替え

#### 2.2.2 ファイルアップロードUI
- **ドラッグ&ドロップエリア**: Material Design準拠のアップロードゾーン
- **プログレスインジケーター**: ファイル読み込み進行状況表示
- **バリデーション結果表示**: アニメーション確認結果の詳細表示
- **エラーメッセージ**: 分かりやすいエラー説明とガイダンス

#### 2.2.3 3Dプレビュー機能
- **リアルタイムプレビュー**: React Three Fiberによる3Dプレビュー
- **アニメーション再生**: 各種アニメーションの動作確認機能
- **カメラコントロール**: マウス/タッチでの視点操作
- **ライティング**: ゲーム内と同様の照明環境

### 2.3 技術仕様

#### 2.3.1 ファイル処理
```typescript
interface LocalAvatarConfig {
  id: string;
  name: string;
  fileUrl: string;
  objectUrl: string;
  fileSize: number;
  uploadDate: string;
  validAnimations: string[];
  isActive: boolean;
}

interface AvatarValidationResult {
  isValid: boolean;
  hasRequiredAnimations: boolean;
  availableAnimations: string[];
  missingAnimations: string[];
  errors: string[];
  warnings: string[];
}
```

#### 2.3.2 データ管理
- **LocalStorage Key**: `nag-won-local-avatars`
- **データ構造**: JSON形式でアバター設定を保存
- **容量管理**: ObjectURLの適切な管理とメモリリーク防止
- **セキュリティ**: ファイル内容の基本的なセキュリティチェック

#### 2.3.3 GLTFローダー拡張
```typescript
interface CustomGLTFLoader {
  loadLocal: (file: File) => Promise<GLTF>;
  validateAnimations: (gltf: GLTF) => AvatarValidationResult;
  extractMetadata: (gltf: GLTF) => AvatarMetadata;
  createObjectURL: (file: File) => string;
  revokeObjectURL: (url: string) => void;
}
```

## 3. 実装設計

### 3.1 コンポーネント構成

```
frontend/src/components/games/nag-won/
├── Avatar/
│   ├── AvatarSelector.tsx          # アバター選択メインコンポーネント
│   ├── LocalAvatarUploader.tsx     # ローカルファイルアップロード
│   ├── AvatarPreview.tsx           # 3Dプレビューコンポーネント
│   ├── AvatarValidator.tsx         # アニメーション検証
│   └── DefaultAvatarList.tsx       # デフォルトアバター一覧
├── Utils/
│   ├── localAvatarManager.ts       # ローカルアバター管理ユーティリティ
│   ├── gltfValidator.ts            # GLTF検証ロジック
│   ├── animationMappings.ts        # アニメーション名マッピング定義
│   └── avatarStore.ts              # Zustand アバター状態管理
```

### 3.2 アニメーション定義ファイル
```typescript
// frontend/src/components/games/nag-won/Utils/animationMappings.ts
export const REQUIRED_ANIMATION_MAPPINGS = {
  'idle': ['Idle', 'idle', 'IDLE', 'idle_clip', 'idle01', 'Idle01'],
  'walking': ['Walk', 'walk', 'WALK', 'Walking', 'WalkForward', 'walk_clip'],
  'running': ['Run', 'run', 'RUN', 'Running', 'Sprint', 'sprint', 'run_clip'],
  'jumping': ['Jump', 'jump', 'JUMP', 'Jumping', 'jump_clip']
} as const;

export const OPTIONAL_ANIMATION_MAPPINGS = {
  'dancing': ['Dance', 'dance', 'DANCE'],
  'waving': ['Wave', 'wave', 'WAVE'],
  'celebrating': ['Celebrate', 'celebrate', 'Victory', 'victory']
} as const;
```

### 3.3 データフロー

1. **ファイル選択**: ユーザーがGLTFファイルを選択
2. **ファイル読み込み**: File APIでファイルを読み込み
3. **GLTF解析**: GLTFLoaderでモデルとアニメーションを解析
4. **アニメーション検証**: 必須アニメーションの存在確認
5. **プレビュー表示**: 3Dプレビューでアニメーション動作確認
6. **ユーザー承認**: ユーザーがアバターを承認
7. **データ保存**: LocalStorageに設定を保存
8. **ゲーム適用**: ゲーム内でローカルアバターを使用

## 4. UI/UX設計

### 4.1 Google Material Design 3 準拠

#### 4.1.1 アバター選択モーダル
- **レイアウト**: Grid レイアウトでアバター一覧表示
- **カード設計**: Material Card with elevated surface
- **アクション**: FAB（Floating Action Button）でローカルアバター追加
- **ナビゲーション**: Tab navigation でデフォルト/カスタム切り替え

#### 4.1.2 ファイルアップロード
- **ドロップゾーン**: Material 3 の outlined container
- **ドラッグ状態**: Dragged state with color transition
- **プログレス**: Linear progress indicator
- **アイコン**: Material Icons 3.0 使用

#### 4.1.3 カラーパレット
```scss
$primary-color: #6750A4;      // Material Purple
$on-primary: #FFFFFF;
$secondary-color: #625B71;    // Material Neutral Variant
$success-color: #4CAF50;      // Material Green
$error-color: #F44336;        // Material Red
$warning-color: #FF9800;      // Material Orange
```

### 4.2 アクセシビリティ（WCAG 2.1 AA準拠）

- **キーボードナビゲーション**: 全機能をキーボードで操作可能
- **スクリーンリーダー対応**: ARIA labels とライブリージョン
- **コントラスト比**: 4.5:1以上を維持
- **フォーカス管理**: 明確なフォーカスインジケーター
- **代替テキスト**: 3Dプレビューの状態をテキストで説明

### 4.3 レスポンシブデザイン

- **デスクトップ**: 3カラムグリッドでアバター表示
- **タブレット**: 2カラムグリッドに調整
- **モバイル**: 1カラムリスト表示
- **タッチ対応**: 44px以上のタッチターゲット
- **モーダル**: 画面サイズに応じたサイズ調整

## 5. エラーハンドリング

### 5.1 ファイル関連エラー
- **不正な形式**: "GLTFまたはGLBファイルを選択してください"
- **サイズ超過**: "ファイルサイズは50MB以下にしてください"
- **読み込み失敗**: "ファイルの読み込みに失敗しました"
- **不正なGLTF**: "有効なGLTFファイルではありません"

### 5.2 アニメーション関連エラー
- **必須アニメーション不足**: "必要なアニメーション（idle, walking, running, jumping）が見つかりません"
- **アニメーション形式エラー**: "アニメーションの形式が正しくありません"
- **再生エラー**: "アニメーションの再生中にエラーが発生しました"

### 5.3 ストレージ関連エラー
- **容量不足**: "ローカルストレージの容量が不足しています"
- **データ破損**: "保存されたアバターデータが破損しています"
- **ファイル削除**: "ローカルファイルが見つかりません。デフォルトアバターに切り替えます"

## 6. パフォーマンス要件

### 6.1 ファイル処理
- **読み込み時間**: 10MB以下のファイルは5秒以内
- **メモリ使用量**: 同時に保持するObjectURLは最大3個
- **キャッシュ**: 一度検証したファイルの結果をキャッシュ

### 6.2 3Dレンダリング
- **プレビューFPS**: 最低30FPS以上を維持
- **LOD**: プレビュー時は低解像度で表示
- **テクスチャ**: 必要に応じて圧縮

### 6.3 ストレージ効率
- **データ圧縮**: メタデータのJSON圧縮
- **ガベージコレクション**: 不要なObjectURLの自動削除
- **容量制限**: ローカルアバター最大10個まで

## 7. セキュリティ考慮事項

### 7.1 ファイル検証
- **MIME type チェック**: `model/gltf+json`, `model/gltf-binary`のみ許可
- **ファイルシグネチャ検証**: GLTFヘッダーの確認
- **スクリプト実行防止**: GLTFファイル内のスクリプト実行を無効化

### 7.2 データ保護
- **個人情報**: ファイル名以外の個人情報は保存しない
- **外部通信**: ローカルファイルの外部送信を禁止
- **sandboxing**: FileReader APIによる安全な読み込み

## 8. 国際化対応

### 8.1 多言語サポート
- **日本語**: プライマリ言語
- **英語**: セカンダリ言語
- **文字列外部化**: i18n ライブラリ使用

### 8.2 ローカライゼーション
- **ファイル名表示**: 各国の文字エンコーディングに対応
- **エラーメッセージ**: 言語ごとに適切なメッセージ
- **日付形式**: 地域に応じた日付表示

## 9. テスト要件

### 9.1 単体テスト
- **ファイル検証ロジック**: 各種GLTFファイルでのテスト
- **アニメーション検証**: 様々なアニメーション名パターンのテスト
- **LocalStorage操作**: データ保存・復元のテスト

### 9.2 統合テスト
- **エンドツーエンド**: ファイル選択からゲーム使用までの流れ
- **エラーシナリオ**: 各種エラー状況の動作確認
- **パフォーマンス**: 大きなファイルでの処理速度テスト

### 9.3 ユーザビリティテスト
- **操作性**: 直感的な操作が可能か
- **エラー理解**: エラーメッセージが分かりやすいか
- **アクセシビリティ**: 支援技術での利用可能性

## 10. 実装フェーズ

### Phase 1: 基盤機能（2週間）
- ローカルファイル読み込み機能
- 基本的なGLTF検証
- シンプルなUI実装

### Phase 2: 高度な検証（1週間）
- アニメーション検証強化
- 詳細なエラーハンドリング
- パフォーマンス最適化

### Phase 3: UI/UX改善（1週間）
- Material Design 3 適用
- アクセシビリティ対応
- レスポンシブデザイン

### Phase 4: 最終調整（1週間）
- 包括的テスト
- パフォーマンス調整
- ドキュメント作成

## 11. 運用・保守

### 11.1 監視項目
- **エラー発生率**: ファイル処理エラーの発生頻度
- **パフォーマンス**: ファイル読み込み時間の監視
- **ユーザー利用率**: ローカルアバター機能の利用状況

### 11.2 更新計画
- **アニメーション対応**: 新しいアニメーション名パターンの追加
- **ファイル形式**: 将来的なGLTF仕様変更への対応
- **機能拡張**: ユーザー要望に基づく機能追加

## 12. 技術的制約・前提条件

### 12.1 ブラウザ対応
- **モダンブラウザ**: Chrome 80+, Firefox 75+, Safari 14+, Edge 80+
- **File API**: FileReader, URL.createObjectURL サポート必須
- **WebGL**: React Three Fiber 動作環境

### 12.2 パフォーマンス制約
- **メモリ**: 同時読み込みファイル数制限
- **CPU**: 3Dレンダリングのフレームレート維持
- **ストレージ**: LocalStorage容量制限への対応

## 13. 実装履歴・技術的知見

### 13.1 2025年6月実装試行結果

#### 13.1.1 実装したコンポーネント
- `SafeGLTFLoader.tsx` - エラーハンドリング付きGLTFローダー
- `AvatarManager.tsx` - カスタムアバター管理専用コンポーネント
- `LocalAvatarUploader.tsx` - ローカルファイルアップロード機能
- `AvatarPreview.tsx` - 3Dプレビューコンポーネント
- `AvatarProvider.tsx` - アバター機能の初期化とゲーム統合
- `gltfValidator.ts` - GLTF検証ユーティリティ
- `animationMappings.ts` - アニメーション名マッピング定義
- `localAvatarManager.ts` - ローカルアバター管理ユーティリティ
- `avatarStore.ts` - Zustand アバター状態管理

#### 13.1.2 技術的課題と学習事項

**データ永続化の課題:**
- ローカルアバターの「アップロード」は実際にはブラウザのLocalStorageに保存される
- ファイルそのものはユーザーのローカルマシンに残り、ObjectURLで参照される
- ページリロード後にファイルアクセスが困難になる問題が発生

**アバター切り替えの課題:**
- React Three FiberとuseGLTFフックのライフサイクル管理が複雑
- モデル切り替え時の適切なクリーンアップとリロードが困難
- keyプロパティによる強制再マウントでも完全な解決に至らず

**GLTFファイル検証の課題:**
- 大きなGLTFファイル（18MB+）のセキュリティチェック調整が必要
- ファイルシグネチャ検証の閾値調整（100バイト→2048バイト）
- 既存のembedded base64テクスチャを含むファイルへの対応

#### 13.1.3 実装上の制約

**LocalStorageの限界:**
```typescript
// ObjectURLは一時的な参照のみ提供
const objectUrl = URL.createObjectURL(file);
// ページリロード後は無効になる
```

**React Three Fiberの制約:**
```typescript
// useGLTFフックのキャッシング機能が切り替えを阻害
const { scene, animations } = useGLTF(modelPath);
// 同一パスの場合、キャッシュされたデータが返される
```

#### 13.1.4 アーキテクチャ上の問題

1. **データ永続化アプローチ**
   - LocalStorageによるメタデータ保存
   - ObjectURLによるファイル参照
   - セッション間でのデータ一貫性の問題

2. **状態管理の複雑性**
   - Zustandストア、ゲーム設定ストア、React状態の3層構造
   - アバター変更イベントの伝播チェーンが複雑
   - プロップドリリングとコンテキストの混在

3. **コンポーネント間の依存関係**
   - Player → SafeGLTFLoader → AvatarProvider → AvatarStore
   - 循環参照に近い依存構造
   - デバッグとメンテナンスの困難性

#### 13.1.5 推奨される代替アプローチ

**サーバーサイド実装:**
- ユーザーアップロード機能をサーバーサイドで実装
- データベース永続化による確実なデータ管理
- CDN配信によるパフォーマンス最適化

**IndexedDBの活用:**
```typescript
// LocalStorageの代わりにIndexedDBを使用
interface AvatarDB {
  avatars: {
    id: string;
    name: string;
    fileBlob: Blob; // ファイルそのものを保存
    metadata: AvatarMetadata;
  }[];
}
```

**WebAssembly活用:**
- GLTFファイル処理をWebAssemblyで高速化
- バリデーション処理の最適化
- メモリ効率の改善

### 13.2 今後の実装指針

#### 13.2.1 優先すべきアプローチ
1. **サーバーサイド実装** - 最も安定した解決策
2. **IndexedDB + Service Worker** - オフライン対応
3. **WebAssembly + IndexedDB** - 高パフォーマンス要求時

#### 13.2.2 避けるべきアプローチ
1. **LocalStorage + ObjectURL** - セッション永続化の問題
2. **複雑なReact状態管理** - デバッグとメンテナンスの困難
3. **過度なuseGLTFフック依存** - キャッシング問題

この要件定義書と実装履歴に基づいて、将来的により堅牢で拡張性の高いローカルアバター機能を実装することで、ユーザーの創造性を最大限に引き出し、リッチでスタイリッシュなゲーム体験を提供できます。