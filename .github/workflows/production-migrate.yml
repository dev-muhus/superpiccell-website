name: Production Database Migration

on:
  push:
    branches: [ main ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      confirm_migration:
        description: 'æœ¬ç•ªãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ (yes/no)'
        required: true
        default: 'no'
        type: choice
        options:
        - 'no'
        - 'yes'

env:
  NODE_VERSION: '18'

jobs:
  # æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  production-migration:
    runs-on: ubuntu-latest
    environment: production # GitHubç’°å¢ƒä¿è­·ãƒ«ãƒ¼ãƒ«ã‚’ä½¿ç”¨
    
    steps:
    - name: Validate migration confirmation
      if: github.event_name == 'workflow_dispatch'
      run: |
        if [ "${{ github.event.inputs.confirm_migration }}" != "yes" ]; then
          echo "âŒ ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡ŒãŒç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Create secure environment file
      run: |
        # ã‚»ã‚­ãƒ¥ã‚¢ãªç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆGitHub Secretsã‹ã‚‰ï¼‰
        cat > frontend/.env.production.local << EOF
        # Database
        DATABASE_URL=${{ secrets.PRODUCTION_DATABASE_URL }}
        NODE_ENV=production
        
        # Clerk Authentication (æœ¬ç•ªç’°å¢ƒç”¨)
        NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${{ secrets.CLERK_PUBLISHABLE_KEY }}
        CLERK_SECRET_KEY=${{ secrets.CLERK_SECRET_KEY }}
        CLERK_WEBHOOK_SECRET=${{ secrets.CLERK_WEBHOOK_SECRET }}
        
        # Cloudinary (æœ¬ç•ªç’°å¢ƒç”¨)
        CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
        CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
        
        # R2 Storage (æœ¬ç•ªç’°å¢ƒç”¨)
        R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
        R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
        MIGRATION_TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
        MIGRATION_COMMIT_SHA=${{ github.sha }}
        MIGRATION_ACTOR=${{ github.actor }}
        EOF
        
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        cd frontend
        npm ci --only=production
        
    - name: Pre-migration validation
      env:
        DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
        NODE_ENV: production
      run: |
        echo "ðŸ” Pre-migration validation..."
        cd frontend
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãƒ†ã‚¹ãƒˆ
        npm run db:verify || {
          echo "âŒ Pre-migration validation failed"
          echo "ðŸš¨ CRITICAL: Database connection or schema validation failed!"
          echo "ðŸ›‘ This indicates a serious issue that must be resolved before proceeding."
          exit 1
        }
        
    - name: Run production database migration
      env:
        DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
        NODE_ENV: production
      run: |
        echo "ðŸš€ Starting production database migration..."
        echo "ðŸ“… Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
        echo "ðŸ”— Commit: ${{ github.sha }}"
        echo "ðŸ‘¤ Actor: ${{ github.actor }}"
        
        cd frontend
        
        # ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆNode.jsç’°å¢ƒã§ç›´æŽ¥å®Ÿè¡Œï¼‰
        echo "ðŸ”„ Running database migrations..."
        npm run db:migrate || {
          echo "âŒ MIGRATION FAILED!"
          echo "ðŸš¨ CRITICAL ERROR: Production database migration has failed!"
          echo "ðŸ›‘ This is a blocking issue that requires immediate attention."
          echo "ðŸ“‹ Troubleshooting steps:"
          echo "   1. Check database connectivity"
          echo "   2. Verify migration files syntax"
          echo "   3. Check for conflicting schema changes"
          echo "   4. Review database permissions"
          echo "ðŸ”— Failed commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Failed by: ${{ github.actor }}"
          exit 1
        }
        
        # ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®æ¤œè¨¼
        echo "âœ… Verifying migration results..."
        npm run db:verify || {
          echo "âŒ POST-MIGRATION VALIDATION FAILED!"
          echo "ðŸš¨ CRITICAL: Migration completed but validation failed!"
          echo "ðŸ›‘ Database may be in an inconsistent state."
          echo "ðŸ“‹ Immediate action required:"
          echo "   1. Check database schema integrity"
          echo "   2. Verify all tables and constraints"
          echo "   3. Consider rollback if necessary"
          exit 1
        }
        
        echo "âœ¨ Production database migration completed successfully!"
        
    - name: Create failure marker on error
      if: failure()
      run: |
        echo "ðŸš¨ MIGRATION FAILURE DETECTED"
        echo "Creating failure marker for monitoring systems..."
        
        # å¤±æ•—æƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
        cat > migration-failure.json << EOF
        {
          "status": "FAILED",
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "commit": "${{ github.sha }}",
          "actor": "${{ github.actor }}",
          "workflow_run": "${{ github.run_id }}",
          "error_type": "MIGRATION_FAILURE",
          "severity": "CRITICAL",
          "action_required": "IMMEDIATE_ATTENTION"
        }
        EOF
        
        echo "ðŸ“„ Failure details:"
        cat migration-failure.json
        
        # å¤±æ•—ã‚’ã‚ˆã‚Šæ˜Žç¢ºã«ã™ã‚‹ãŸã‚ã€æ˜Žç¤ºçš„ã«exit 1
        echo "ðŸ›‘ Workflow marked as FAILED due to migration issues"
        exit 1
        
    - name: Generate migration report
      if: success()
      run: |
        echo "ðŸ“Š Generating migration report..."
        cat > migration-report.md << EOF
        # Production Migration Report
        
        **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Commit**: ${{ github.sha }}
        **Actor**: ${{ github.actor }}
        **Status**: âœ… SUCCESS
        **Workflow Run**: ${{ github.run_id }}
        
        ## Migration Details
        - Environment: Production
        - Database: Neon DB
        - Method: Node.js via GitHub Actions
        - Security: GitHub Secrets + Environment Protection
        
        ## Verification
        - Pre-migration validation: âœ… PASSED
        - Migration execution: âœ… PASSED  
        - Post-migration validation: âœ… PASSED
        
        ## Next Steps
        - Monitor application performance
        - Verify all features are working correctly
        - Check for any unexpected behavior
        EOF
        
        echo "ðŸ“‹ Migration report generated"
        cat migration-report.md
        
    - name: Notify migration status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Production database migration completed successfully"
          echo "ðŸ”— Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Executed by: ${{ github.actor }}"
          echo "ðŸŒ Workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        else
          echo "âŒ PRODUCTION DATABASE MIGRATION FAILED"
          echo "ðŸš¨ CRITICAL FAILURE - IMMEDIATE ACTION REQUIRED"
          echo "ðŸ”— Failed commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Failed by: ${{ github.actor }}"
          echo "ðŸŒ Failed workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ðŸ›‘ IMPORTANT: This failure indicates that:"
          echo "   - Code was pushed to main branch"
          echo "   - But database migration failed"
          echo "   - Application may be in inconsistent state"
          echo ""
          echo "ðŸ“‹ Required actions:"
          echo "   1. Do NOT deploy application until migration is fixed"
          echo "   2. Investigate migration failure immediately"
          echo "   3. Fix migration issues"
          echo "   4. Re-run migration or push fix"
          echo ""
          exit 1 